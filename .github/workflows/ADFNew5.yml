name: ADF_New_5

on: 
  workflow_dispatch

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_RESOURCE_GROUP: "rg-test-uat-001" #DestinationRG
  ARM_FACTORY_NAME: "adf-testproject-uat-001" #DestinationDF
  SourceWorkspaceName: "adf-testproject-dev-001" #SourceADF

jobs:
  deploy:
    runs-on:  ubuntu-latest

    steps:
    - name: checkout main branch
      uses: actions/checkout@v3
    - name: Checkout adf_publish branch
      uses: actions/checkout@v3
      with:
        ref: adf_publish
      
    - name: Install azure-cli
  # You may pin to the exact commit or the version.
  # uses: pietrobolcato/install-azure-cli-action@f01ae8ab9274a69a854ef40018c9686d60d4891e
      uses: pietrobolcato/install-azure-cli-action@v1

    - name: Login to Azure
      run: |
         az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
         az account set --subscription $ARM_SUBSCRIPTION_ID
    - name: Deploy ARM Templates
      run: |
        az account set --subscription "$ARM_SUBSCRIPTION_ID"
        az deployment group create --resource-group "$ARM_RESOURCE_GROUP" --template-file /adf-testproject-dev-001/ARMTemplateForFactory.json --parameters  /adf-testproject-dev-001/ARMTemplateParametersForFactory.json --name "$ARM_FACTORY_NAME"
